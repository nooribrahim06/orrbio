{% extends "layout.html" %}
{% set active_page = 'safety' %}
{% block title %}Orbio - Safety{% endblock %}

{% block content %}
<section class="services">
  <h2 class="section-title">Safety</h2>
  <h2 class="section-text">See satellites and debris in real time ‚Äî awareness that keeps orbit safer</h2>

<div class="analyzer">
  <div class="analyzer-card">
    <h2>üöÄ Collision Risk Analyzer (LEO)</h2>
    <p>Enter state vectors for both objects. We‚Äôll estimate closest approach and risk.</p>

    <form method="POST" action="{{ url_for('safety') }}" id="riskForm" novalidate>
      <div class="form-sections">

        <!-- Satellite -->
        <div class="fieldset">
          <div class="legend">üì° Satellite ‚Äî State Vector</div>

          <!-- NEW: Optional TLE -->
          <div class="field" style="margin-bottom: 12px;">
            <label for="sat_tle">Satellite TLE (optional)</label>
            <textarea id="sat_tle" name="sat_tle" rows="3" class="text-area" placeholder="Paste two-line element set here">{{ request.form.get('sat_tle','') }}</textarea>
            <small class="hint">If provided, we‚Äôll convert this TLE to (x,y,z,vx,vy,vz) at the TLE epoch and ignore the manual fields.</small>
            {% if sat_tle_error %}<div class="alert alert-danger" style="margin-top:6px">{{ sat_tle_error }}</div>{% endif %}
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="sat_x">X</label>
              <div class="input-wrap">
                <input id="sat_x" name="sat_x" type="number" step="any" required value="{{ request.form.get('sat_x', 7000) }}">
                <span class="unit">km</span>
              </div>
            </div>
            <div class="field">
              <label for="sat_y">Y</label>
              <div class="input-wrap">
                <input id="sat_y" name="sat_y" type="number" step="any" required value="{{ request.form.get('sat_y', 2000) }}">
                <span class="unit">km</span>
              </div>
            </div>
            <div class="field">
              <label for="sat_z">Z</label>
              <div class="input-wrap">
                <input id="sat_z" name="sat_z" type="number" step="any" required value="{{ request.form.get('sat_z', 1300) }}">
                <span class="unit">km</span>
              </div>
            </div>

            <div class="field">
              <label for="sat_vx">Vx</label>
              <div class="input-wrap">
                <input id="sat_vx" name="sat_vx" type="number" step="any" required value="{{ request.form.get('sat_vx', 1) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
            <div class="field">
              <label for="sat_vy">Vy</label>
              <div class="input-wrap">
                <input id="sat_vy" name="sat_vy" type="number" step="any" required value="{{ request.form.get('sat_vy', 7) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
            <div class="field">
              <label for="sat_vz">Vz</label>
              <div class="input-wrap">
                <input id="sat_vz" name="sat_vz" type="number" step="any" required value="{{ request.form.get('sat_vz', 2) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Debris -->
        <div class="fieldset">
          <div class="legend">üõ∞ Debris ‚Äî State Vector</div>

          <!-- NEW: Optional TLE -->
          <div class="field" style="margin-bottom: 12px;">
            <label for="deb_tle">Debris TLE (optional)</label>
            <textarea id="deb_tle" name="deb_tle" rows="3" class="text-area" placeholder="Paste two-line element set here">{{ request.form.get('deb_tle','') }}</textarea>
            <small class="hint">If provided, we‚Äôll convert this TLE to (x,y,z,vx,vy,vz) at the TLE epoch and ignore the manual fields.</small>
            {% if deb_tle_error %}<div class="alert alert-danger" style="margin-top:6px">{{ deb_tle_error }}</div>{% endif %}
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="deb_x">X</label>
              <div class="input-wrap">
                <input id="deb_x" name="deb_x" type="number" step="any" required value="{{ request.form.get('deb_x', 7020) }}">
                <span class="unit">km</span>
              </div>
            </div>
            <div class="field">
              <label for="deb_y">Y</label>
              <div class="input-wrap">
                <input id="deb_y" name="deb_y" type="number" step="any" required value="{{ request.form.get('deb_y', 1995) }}">
                <span class="unit">km</span>
              </div>
            </div>
            <div class="field">
              <label for="deb_z">Z</label>
              <div class="input-wrap">
                <input id="deb_z" name="deb_z" type="number" step="any" required value="{{ request.form.get('deb_z', 1305) }}">
                <span class="unit">km</span>
              </div>
            </div>

            <div class="field">
              <label for="deb_vx">Vx</label>
              <div class="input-wrap">
                <input id="deb_vx" name="deb_vx" type="number" step="any" required value="{{ request.form.get('deb_vx', 1) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
            <div class="field">
              <label for="deb_vy">Vy</label>
              <div class="input-wrap">
                <input id="deb_vy" name="deb_vy" type="number" step="any" required value="{{ request.form.get('deb_vy', 6.8) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
            <div class="field">
              <label for="deb_vz">Vz</label>
              <div class="input-wrap">
                <input id="deb_vz" name="deb_vz" type="number" step="any" required value="{{ request.form.get('deb_vz', 2.1) }}">
                <span class="unit">km/s</span>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="actions">
        <button type="submit" class="analyze-btn">üîç Analyze</button>
        <button type="reset" class="reset-btn">Reset</button>
      </div>
    </form>

    {% if result %}
    <div class="result-card">
      <h3>üìä Results</h3>
      <table>
        <tr><th>Closest Distance</th><td>{{ result.min_dist }} km</td></tr>
        <tr><th>Time of Closest Approach</th><td>{{ result.time_of_min }} minutes</td></tr>
        <tr><th>Risk Evaluation</th><td>{{ result.risk }}</td></tr>
        <tr><th>Threat Level</th><td>{{ result.risk_percentage }} %</td></tr>
      </table>
      <div class="progress-container">
        <div id="progress-bar"
             class="progress-bar {% if result.risk_percentage < 30 %}low{% elif result.risk_percentage < 70 %}medium{% else %}high{% endif %}">
          {{ result.risk_percentage }}%
        </div>
      </div>

      <!-- NEW: echo derived xyz/v from TLE if present -->
      {% if sat_derived or deb_derived %}
      <hr>
      <h4>üß≠ State vectors derived from TLE (ECI-like @ TLE epoch)</h4>
      <div class="form-grid">
        {% if sat_derived %}
        <div class="field">
          <strong>Satellite position (km)</strong>
          <div>x={{ "%.6f"|format(sat_derived.position[0]) }}, y={{ "%.6f"|format(sat_derived.position[1]) }}, z={{ "%.6f"|format(sat_derived.position[2]) }}</div>
          <small>velocity (km/s): vx={{ "%.6f"|format(sat_derived.velocity[0]) }}, vy={{ "%.6f"|format(sat_derived.velocity[1]) }}, vz={{ "%.6f"|format(sat_derived.velocity[2]) }}</small>
        </div>
        {% endif %}
        {% if deb_derived %}
        <div class="field">
          <strong>Debris position (km)</strong>
          <div>x={{ "%.6f"|format(deb_derived.position[0]) }}, y={{ "%.6f"|format(deb_derived.position[1]) }}, z={{ "%.6f"|format(deb_derived.position[2]) }}</div>
          <small>velocity (km/s): vx={{ "%.6f"|format(deb_derived.velocity[0]) }}, vy={{ "%.6f"|format(deb_derived.velocity[1]) }}, vz={{ "%.6f"|format(deb_derived.velocity[2]) }}</small>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
<br>

<div class="debris-map">
  <h2 class="section-text">Real-Time Space Debris Map</h2>
  <div class="debris-frame">
    <iframe
      src="https://stuffin.space/"
      title="Real-Time Space Debris Visualization"
      loading="lazy"
      allowfullscreen>
    </iframe>
  </div>
</div>
</section>
  <section id="assistant" aria-live="polite" aria-label="Site assistant">
    <img
      src="{{ url_for('static', filename='img/robot.jpg.jpg') }}"
      alt="Assistant guide"
      class="avatar"
      id="avatar"
      loading="lazy"
    />
    <div class="bubble" id="bubble-box">
      <p id="bubble-text">Hello üëã! I'm here to guide you through the website.</p>
      <button id="next-btn" type="button" aria-label="Next message">Next ‚è≠</button>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const bar=document.getElementById('progress-bar');
    if(bar){ const pct=parseFloat(bar.textContent)||0; requestAnimationFrame(()=>{ bar.style.width=pct+'%'; }); }
  })();
  const phrases=[
    "Hosted payloads. Real missions. Real returns.",
    "LEO access for investors, builders, and schools.",
    "Safer, faster, and more sustainable operations."
  ];
  (function () {
    const phrases = [
      "Hosted payloads. Real missions. Real returns.",
      "LEO access for investors, builders, and schools.",
      "Safer, faster, and more sustainable operations."
    ];
    const typeEl = document.getElementById('typeTarget');
    if (!typeEl) return; // <‚Äî prevents crash on pages without #typeTarget

    let pi = 0, ci = 0, typing = true, hold = 0;
    function typeLoop() {
      const p = phrases[pi];
      if (typing) {
        ci++; typeEl.textContent = p.slice(0, ci);
        if (ci === p.length) { typing = false; hold = 18; }
      } else {
        if (hold > 0) { hold--; }
        else { ci--; typeEl.textContent = p.slice(0, ci);
          if (ci === 0) { typing = true; pi = (pi + 1) % phrases.length; }
        }
      }
      requestAnimationFrame(() => setTimeout(typeLoop, typing ? 28 : 18));
    }
    window.addEventListener('load', typeLoop);
  })();

  // ---- ASSISTANT TOUR (guards for required assistant nodes)
  (function () {
    const bubbleBox = document.getElementById("bubble-box");
    const bubbleText = document.getElementById("bubble-text");
    const nextBtn = document.getElementById("next-btn");
    const avatar = document.getElementById("avatar");
    if (!bubbleBox || !bubbleText || !nextBtn || !avatar) return; // if assistant HTML wasn‚Äôt rendered

const messages = [
  "üõ∞Ô∏è Welcome to Safety! Let‚Äôs check for collision risks together.",
  "üìç First step: paste the satellite‚Äôs position data you got from Space-Track.",
  "üî¢ Make sure you‚Äôve included both position and velocity (x, y, z + vx, vy, vz).",
  "üí° Pro tip: if you‚Äôre testing, try two satellites close in orbit to see a higher risk.",
  "üö¶ Once you hit ‚ÄòAnalyze‚Äô, I‚Äôll calculate the probability of conjunction for you."
];


    let index = 0;
    let intervalId = null;

    function showNextMessage() {
      index++;
      if (index < messages.length) {
        bubbleText.textContent = messages[index];
        // Optional animation: only works if you added @keyframes bounceIn in base CSS
        bubbleBox.style.animation = "bounceIn 0.8s";
      } else {
        stopInterval();
        bubbleBox.style.display = "none";
      }
    }

    function startInterval(ms = 8000) { stopInterval(); intervalId = setInterval(showNextMessage, ms); }
    function stopInterval() { if (intervalId) { clearInterval(intervalId); intervalId = null; } }

    nextBtn.addEventListener("click", showNextMessage);
    startInterval(8000);

    avatar.addEventListener("click", () => {
      index = 0;
      bubbleText.textContent = messages[index];
      bubbleBox.style.display = "block";
      bubbleBox.style.animation = "bounceIn 0.8s";
      startInterval(6000);
    });
  })();




  /* (kept your existing assistant scripts exactly as-is) */
</script>
{% endblock %}
